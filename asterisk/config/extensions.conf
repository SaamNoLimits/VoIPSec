[general]
static=yes
writeprotect=no
clearglobalvars=no

[globals]
; Global variables
CONSOLE=Console/dsp
IAXINFO=guest
TRUNK=SIP/sip-trunk
TRUNKMSD=1

; Emergency numbers
EMERGENCY=911
LOCAL_EMERGENCY=911

; Feature codes
VOICEMAIL_MAIN=*97
VOICEMAIL_DIRECT=*98
CALL_FORWARD_ALL=*72
CALL_FORWARD_CANCEL=*73
DO_NOT_DISTURB_ON=*78
DO_NOT_DISTURB_OFF=*79
CALL_PICKUP=*8
DIRECTED_PICKUP=**

[macro-stdexten]
; Standard extension macro
exten => s,1,Dial(${ARG1},20,tT)
exten => s,2,Goto(s-${DIALSTATUS},1)
exten => s-NOANSWER,1,Voicemail(${MACRO_EXTEN},u)
exten => s-NOANSWER,2,Hangup()
exten => s-BUSY,1,Voicemail(${MACRO_EXTEN},b)
exten => s-BUSY,2,Hangup()
exten => s-UNAVAIL,1,Voicemail(${MACRO_EXTEN},u)
exten => s-UNAVAIL,2,Hangup()
exten => s-CANCEL,1,Hangup()
exten => _s-.,1,Goto(s-NOANSWER,1)

[macro-dial-trunk]
; Trunk dialing macro with call recording
exten => s,1,Set(CALLERID(num)=${CALLERID(num)})
exten => s,2,GotoIf($["${CALLERID(num)}" = ""]?3:4)
exten => s,3,Set(CALLERID(num)=Unknown)
exten => s,4,Set(CDR(accountcode)=${CALLERID(num)})
exten => s,5,MixMonitor(${STRFTIME(${EPOCH},,%Y%m%d-%H%M%S)}-${CALLERID(num)}-${ARG1}.wav)
exten => s,6,Dial(${TRUNK}/${ARG1},60,tT)
exten => s,7,Goto(s-${DIALSTATUS},1)
exten => s-NOANSWER,1,Hangup()
exten => s-BUSY,1,Busy(10)
exten => s-BUSY,2,Hangup()
exten => s-UNAVAIL,1,Playback(ss-noservice)
exten => s-UNAVAIL,2,Hangup()
exten => s-CANCEL,1,Hangup()
exten => _s-.,1,Goto(s-NOANSWER,1)

[internal]
; Internal extensions context
include => parkedcalls
include => features
include => conferences

; Extension 1001-1099 (Users)
exten => _10XX,1,Macro(stdexten,SIP/${EXTEN})

; Extension 2001-2099 (Departments)
exten => 2001,1,Dial(SIP/1001&SIP/1002&SIP/1003,20,tT)
exten => 2001,2,Voicemail(2001,u)
exten => 2001,3,Hangup()

; Extension 3001-3099 (Services)
exten => 3001,1,Directory(default,internal,f)
exten => 3002,1,Echo()
exten => 3003,1,Milliwatt()
exten => 3004,1,SayUnixTime()

; Voicemail access
exten => ${VOICEMAIL_MAIN},1,VoiceMailMain()
exten => ${VOICEMAIL_MAIN},2,Hangup()

; Direct voicemail access
exten => _${VOICEMAIL_DIRECT}XXXX,1,VoiceMailMain(${EXTEN:3})
exten => _${VOICEMAIL_DIRECT}XXXX,2,Hangup()

; Call forwarding
exten => _${CALL_FORWARD_ALL}.,1,Set(DB(CF/${CALLERID(num)})=${EXTEN:3})
exten => _${CALL_FORWARD_ALL}.,2,Playback(call-fwd-unconditional)
exten => _${CALL_FORWARD_ALL}.,3,Playback(for)
exten => _${CALL_FORWARD_ALL}.,4,Playback(extension)
exten => _${CALL_FORWARD_ALL}.,5,SayDigits(${EXTEN:3})
exten => _${CALL_FORWARD_ALL}.,6,Playback(is-set-to)
exten => _${CALL_FORWARD_ALL}.,7,Hangup()

exten => ${CALL_FORWARD_CANCEL},1,DBdel(CF/${CALLERID(num)})
exten => ${CALL_FORWARD_CANCEL},2,Playbook(call-fwd-cancelled)
exten => ${CALL_FORWARD_CANCEL},3,Hangup()

; Do Not Disturb
exten => ${DO_NOT_DISTURB_ON},1,Set(DB(DND/${CALLERID(num)})=YES)
exten => ${DO_NOT_DISTURB_ON},2,Playback(do-not-disturb)
exten => ${DO_NOT_DISTURB_ON},3,Playback(activated)
exten => ${DO_NOT_DISTURB_ON},4,Hangup()

exten => ${DO_NOT_DISTURB_OFF},1,DBdel(DND/${CALLERID(num)})
exten => ${DO_NOT_DISTURB_OFF},2,Playback(do-not-disturb)
exten => ${DO_NOT_DISTURB_OFF},3,Playback(cancelled)
exten => ${DO_NOT_DISTURB_OFF},4,Hangup()

; Call pickup
exten => ${CALL_PICKUP},1,Pickup()
exten => _${DIRECTED_PICKUP}XXXX,1,Pickup(${EXTEN:2}@internal)

; Emergency calls
exten => ${EMERGENCY},1,Macro(dial-trunk,${EMERGENCY})
exten => ${LOCAL_EMERGENCY},1,Macro(dial-trunk,${LOCAL_EMERGENCY})

[conferences]
; Conference rooms
exten => 8000,1,Answer()
exten => 8000,2,Wait(1)
exten => 8000,3,ConfBridge(general,default_bridge,default_user)
exten => 8000,4,Hangup()

exten => 8001,1,Answer()
exten => 8001,2,Wait(1)
exten => 8001,3,ConfBridge(meeting1,default_bridge,default_user)
exten => 8001,4,Hangup()

exten => 8002,1,Answer()
exten => 8002,2,Wait(1)
exten => 8002,3,ConfBridge(meeting2,default_bridge,default_user)
exten => 8002,4,Hangup()

[features]
; Feature codes context
exten => 700,1,Answer()
exten => 700,2,Wait(1)
exten => 700,3,Playback(demo-echotest)
exten => 700,4,Echo()
exten => 700,5,Playback(demo-echodone)
exten => 700,6,Hangup()

[from-trunk]
; Incoming calls from trunk
include => internal

; Handle incoming calls
exten => _X.,1,Set(DID=${EXTEN})
exten => _X.,2,Goto(incoming,${DID},1)

[incoming]
; Incoming call routing
exten => _X.,1,Answer()
exten => _X.,2,Wait(2)
exten => _X.,3,Set(TIMEOUT(digit)=5)
exten => _X.,4,Set(TIMEOUT(response)=10)
exten => _X.,5,Background(welcome)
exten => _X.,6,WaitExten()

; Route to departments
exten => 1,1,Goto(internal,2001,1)  ; Sales
exten => 2,1,Goto(internal,2002,1)  ; Support
exten => 3,1,Goto(internal,2003,1)  ; Billing
exten => 0,1,Goto(internal,1001,1)  ; Operator

; Invalid extension
exten => i,1,Playback(invalid)
exten => i,2,Goto(s,6)

; Timeout
exten => t,1,Playback(vm-goodbye)
exten => t,2,Hangup()

[outbound]
; Outbound calling context
include => internal

; Local calls (7 digits)
exten => _NXXXXXX,1,Macro(dial-trunk,${EXTEN})

; Long distance (1 + 10 digits)
exten => _1NXXNXXXXXX,1,Macro(dial-trunk,${EXTEN})

; International (011 + country code + number)
exten => _011.,1,Macro(dial-trunk,${EXTEN})

; Toll-free numbers
exten => _1800NXXXXXX,1,Macro(dial-trunk,${EXTEN})
exten => _1888NXXXXXX,1,Macro(dial-trunk,${EXTEN})
exten => _1877NXXXXXX,1,Macro(dial-trunk,${EXTEN})
exten => _1866NXXXXXX,1,Macro(dial-trunk,${EXTEN})

[default]
; Default context (should be restrictive)
include => internal

[parkedcalls]
; Call parking
exten => 701,1,ParkedCall(701)
exten => 702,1,ParkedCall(702)
exten => 703,1,ParkedCall(703)
